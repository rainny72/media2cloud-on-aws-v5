// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0
const {
  TSNE,
} = require('@keckelt/tsne');

class Tsne extends TSNE {
  constructor(options = {}) {
    super(options);

    if (typeof options.distanceFn === 'function') {
      this.$distanceFn = options.distanceFn;
    }
  }

  get distanceFn() {
    return this.$distanceFn;
  }

  initDataRaw(X) {
    const N = X.length;
    const dists = this.xtod(X);
    this.P = this.d2p(dists, this.perplexity, 1e-4);
    this.N = N;
    this.initSolution();
  }

  xtod(X) {
    const fn = this.distanceFn;

    if (fn === undefined) {
      return super.xtod(X);
    }

    const N = X.length;
    const dist = this.zeros(N * N);
    for (let i = 0; i < N; i++) {
      for (let j = i + 1; j < N; j++) {
        const d = fn(X[i], X[j]);
        dist[i * N + j] = d;
        dist[j * N + i] = d;
      }
    }
    return dist;
  }
}


module.exports = Tsne;
